function createJsTree(){$("#BaseTree").jstree({core:{check_callback:!0,multiple:!1},types:{team:{icon:"fas fa-users",valid_children:["student"]},student:{icon:"fas fa-user",valid_children:"none"}},contextmenu:{items:treeContextMenuSetup},plugins:["conditionalselect","sort","wholerow","unique","types","contextmenu"]});$("#BaseTree").on("changed.jstree",function(n,t){if(jstreeSelectedItem={id:t.node.data.jstree.id,type:t.node.data.jstree.type},jstreeSelectedItem.type==="student"){var i={id:jstreeSelectedItem.id};$.getJSON("api/v1/student",i,onStudentLoadedFromJsTreeChanged)}jstreeSelectedItem.type==="team"&&$("#StudentContent").hide()})}function treeContextMenuSetup(n){var t={addStudent:{label:"Добавить студента",action:function(){$("#m_SaveStudentButton").hide();$("#m_AddStudentButton").show();resetModalDialogsFields();loadTeamsInStudentModalDialog();$("#EditStudentDialog").modal("show")}},update:{label:"Изменить",action:function(){var n={id:jstreeSelectedItem.id};jstreeSelectedItem.type==="student"&&($.getJSON("api/v1/student",n,onStudentEditClicked),$("#m_SaveStudentButton").show(),$("#m_AddStudentButton").hide(),$("#EditStudentDialog").modal("show"));jstreeSelectedItem.type==="team"&&($.getJSON("api/v1/team",n,onTeamEditClicked),$("#m_SaveTeamButton").show(),$("#m_AddTeamButton").hide(),$("#EditTeamDialog").modal("show"))}},remove:{label:"Удалить",action:function(){jstreeSelectedItem.type==="team"&&confirm("Удалить взвод? Будут удалены все студенты этого взвода...")&&$.ajax({url:"api/v1/team",type:"DELETE",data:{id:n.data.jstree.id},success:function(){refillJsTree()},statusCode:{500:function(n){alert("Необработанная ошибка на сервере. Обратитесь к разрабочтику \n\nТекст ошибки: "+n.responseText)}},error:function(n,t,i){alert(i)}});jstreeSelectedItem.type==="student"&&confirm("Удалить студента?")&&$.ajax({url:"api/v1/student",type:"DELETE",data:{id:n.data.jstree.id},success:function(){var n=$("#BaseTree").jstree().get_selected()[0],t=$("#BaseTree").jstree().get_node(n);$("#BaseTree").jstree().delete_node(t)},statusCode:{500:function(n){alert("Необработанная ошибка на сервере. Обратитесь к разрабочтику \n\nТекст ошибки: "+n.responseText)}},error:function(n,t,i){alert(i)}})}}};return n.type==="student"&&delete t.addStudent,t}function addOrUpdateStudent(n){var t={Id:jstreeSelectedItem.id,FirstName:$("#m_FirstName").val(),LastName:$("#m_LastName").val(),MiddleName:$("#m_MiddleName").val(),Group:$("#m_Group").val(),TeamId:$("#m_Team").val()};$.ajax({url:"api/v1/student",type:n,contentType:"application/json; charset=UTF-8",success:function(){refillJsTree()},statusCode:{500:function(n){alert("Необработанная ошибка на сервере. Обратитесь к разрабочтику \n\nТекст ошибки: "+n.responseText)}},error:function(n,t,i){alert(i)},data:JSON.stringify(t)})}function addOrUpdateTeam(n){var t={id:jstreeSelectedItem.id,number:$("#m_TeamNumber").val()};$.ajax({url:"api/v1/team",type:n,contentType:"application/json; charset=UTF-8",success:function(){refillJsTree()},statusCode:{500:function(n){alert("Необработанная ошибка на сервере. Обратитесь к разрабочтику \n\nТекст ошибки: "+n.responseText)}},error:function(n,t,i){alert(i)},data:JSON.stringify(t)})}function onStudentEditClicked(n){n.student!=null&&($("#m_LastName").val(n.student.lastName),$("#m_FirstName").val(n.student.firstName),$("#m_MiddleName").val(n.student.middleName),$("#m_Group").val(n.student.group),loadTeamsInStudentModalDialog(n))}function onTeamEditClicked(n){$("#m_TeamNumber").val(n.number)}function onStudentLoadedFromJsTreeChanged(n){n.student!=null&&($("#SelectedStudent").text(n.student.fullName),$("#CurrentStudentLastName").text(n.student.lastName),$("#CurrentStudentFirstName").text(n.student.firstName),$("#CurrentStudentMiddleName").text(n.student.middleName),$("#CurrentStudentGroup").text(n.student.group),$("#CurrentStudentTeam").text(n.student.team.number),$("#CurrentStudentAverageValue").text(n.student.averageValue),$("#CurrentStudentHistory").empty(),$.each(n.history,function(n,t){$("#CurrentStudentHistory").append("<tr><td>"+moment(t.date).format("DD.MM.YYYY HH:mm")+"<\/td><td>"+t.value+"<\/td><td>"+t.algorithmName+"<\/td><\/tr>")}),$("#StudentContent").show())}function resetModalDialogsFields(){$("#m_LastName").val("");$("#m_FirstName").val("");$("#m_MiddleName").val("");$("#m_Group").val("");$("#m_Team").val("");$("#m_TeamNumber").val("")}function refillJsTree(){$.getJSON("api/v1/setup",function(n){$("#BaseTree").jstree("destroy");var t="<ul>";$.each(n,function(i,r){t=t+'<li data-jstree=\'{"type":"team","id":"'+r.id+"\"}'>"+r.number+" взвод<ul>";$.each(n[i].students,function(n,i){t=t+'<li data-jstree=\'{"type":"student","id":"'+i.id+"\"}'>"+i.fullName+"<\/li>"});t=t+"<\/ul><\/li>"});t=t+"<\/ul>";$("#BaseTree").append(t);createJsTree()})}function loadTeamsInStudentModalDialog(n){$.getJSON("api/v1/teams",function(t){onTeamsLoaded(t);jstreeSelectedItem.type==="student"&&$("#m_Team").val(n.student.team.id);jstreeSelectedItem.type==="team"&&$("#m_Team").val(jstreeSelectedItem.id)})}function onTeamsLoaded(n){$("#m_Team").empty();$.each(n,function(n,t){$("#m_Team").append('<option value="'+t.id+'">'+t.number+"<\/option>")})}var jstreeSelectedItem={id:-1,type:undefined};$(refillJsTree());$("#addTeamButton").click(function(){$("#m_SaveTeamButton").hide();$("#m_AddTeamButton").show();resetModalDialogsFields();$("#EditTeamDialog").modal("show")});$("#m_SaveStudentButton").click(function(){addOrUpdateStudent("PUT")});$("#m_AddStudentButton").click(function(){addOrUpdateStudent("POST")});$("#m_SaveTeamButton").click(function(){addOrUpdateTeam("PUT")});$("#m_AddTeamButton").click(function(){addOrUpdateTeam("POST")});